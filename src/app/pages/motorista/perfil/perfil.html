<!-- Header -->
<div class="pt-20 bg-slate-950">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <span class="text-brand-green text-sm font-semibold tracking-widest uppercase">Perfil</span>
    <h1 class="text-4xl sm:text-5xl font-bold text-white mt-3 leading-tight">Meu Perfil</h1>
    <p class="text-slate-300 text-lg mt-3 leading-relaxed">
      Gerencie seus dados pessoais e informações do caminhão.
    </p>
  </div>
</div>

<!-- Content -->
<section class="py-10 bg-slate-50 min-h-screen">
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 space-y-6">

    @if (loading()) {
      @for (i of [1, 2]; track i) {
        <div class="bg-white rounded-2xl border border-slate-200 p-8 animate-pulse space-y-4">
          <div class="h-5 bg-slate-200 rounded w-48"></div>
          <div class="grid grid-cols-2 gap-4 mt-6">
            @for (j of [1,2,3,4]; track j) {
              <div class="space-y-1.5">
                <div class="h-3 bg-slate-200 rounded w-24"></div>
                <div class="h-4 bg-slate-100 rounded w-36"></div>
              </div>
            }
          </div>
        </div>
      }
    } @else if (error()) {
      <div class="bg-red-50 border border-red-200 rounded-2xl p-6 text-center">
        <p class="text-red-700">{{ error() }}</p>
        <button hlmBtn variant="outline" class="mt-3" (click)="loadAll()">Tentar novamente</button>
      </div>
    } @else {

      <!-- ── Dados Pessoais ─────────────────────────────────────── -->

      @if (savePersonalSuccess()) {
        <div class="bg-green-50 border border-green-200 rounded-xl px-4 py-3 flex items-center gap-3">
          <svg class="w-5 h-5 text-green-600 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 6 9 17l-5-5"/>
          </svg>
          <p class="text-sm text-green-700 font-medium">Dados pessoais atualizados!</p>
        </div>
      }

      @if (!editPersonal()) {
        <!-- View: dados pessoais -->
        <div class="bg-white rounded-2xl border border-slate-200 p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-slate-900">Dados Pessoais</h2>
            <div class="flex items-center gap-3">
              @if (profile()) {
                <span hlmBadge [variant]="approvalClass(profile()!.approval_status)">
                  {{ approvalLabel(profile()!.approval_status) }}
                </span>
              }
              <button hlmBtn variant="outline" size="sm" (click)="startEditPersonal()">Editar</button>
            </div>
          </div>

          @if (profile()) {
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5">
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Nome</dt>
                <dd class="mt-1 text-sm text-slate-900">{{ profile()!.profile.name }}</dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Telefone</dt>
                <dd class="mt-1 text-sm text-slate-900">{{ profile()!.profile.phone }}</dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">CPF</dt>
                <dd class="mt-1 text-sm text-slate-900 font-mono">{{ profile()!.cpf }}</dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Data de Nascimento</dt>
                <dd class="mt-1 text-sm text-slate-900">{{ profile()!.birth_date || '—' }}</dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Número da CNH</dt>
                <dd class="mt-1 text-sm text-slate-900 font-mono">{{ profile()!.driver_license_number }}</dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Categoria</dt>
                <dd class="mt-1 text-sm text-slate-900 font-semibold">{{ profile()!.driver_license_category }}</dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Validade da CNH</dt>
                <dd class="mt-1 text-sm text-slate-900">{{ profile()!.driver_license_expiry }}</dd>
              </div>
            </dl>
          }
        </div>

      } @else {
        <!-- Edit: dados pessoais -->
        <div class="bg-white rounded-2xl border border-slate-200 p-6">
          <h2 class="text-lg font-semibold text-slate-900 mb-6">Editar Dados Pessoais</h2>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1.5">Nome completo</label>
              <input hlmInput type="text" [(ngModel)]="editName" class="w-full" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1.5">Telefone</label>
              <input hlmInput type="tel" [(ngModel)]="editPhone" class="w-full" [appMask]="'phone'" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1.5">Data de Nascimento</label>
              <input hlmInput type="date" [(ngModel)]="editBirthDate" class="w-full" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1.5">Número da CNH</label>
              <input hlmInput type="text" [(ngModel)]="editLicenseNumber" class="w-full" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1.5">Categoria da CNH</label>
              <input hlmInput type="text" [(ngModel)]="editLicenseCategory" maxlength="2" placeholder="ex: E" class="w-full uppercase" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1.5">Validade da CNH</label>
              <input hlmInput type="date" [(ngModel)]="editLicenseExpiry" class="w-full" />
            </div>
          </div>

          @if (savePersonalError()) {
            <p class="text-sm text-red-600 mt-4">{{ savePersonalError() }}</p>
          }

          <div class="mt-6 flex justify-end gap-3">
            <button hlmBtn variant="outline" (click)="cancelEditPersonal()">Cancelar</button>
            <button hlmBtn (click)="savePersonal()" [disabled]="savingPersonal()">
              @if (savingPersonal()) { Salvando... } @else { Salvar alterações }
            </button>
          </div>
        </div>
      }

      <!-- ── Meu Caminhão ────────────────────────────────────────── -->

      @if (saveTruckSuccess()) {
        <div class="bg-green-50 border border-green-200 rounded-xl px-4 py-3 flex items-center gap-3">
          <svg class="w-5 h-5 text-green-600 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 6 9 17l-5-5"/>
          </svg>
          <p class="text-sm text-green-700 font-medium">Dados do caminhão atualizados!</p>
        </div>
      }

      @if (!editTruck()) {
        <!-- View: caminhão -->
        <div class="bg-white rounded-2xl border border-slate-200 p-6">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-slate-900">Meu Caminhão</h2>
            <button hlmBtn variant="outline" size="sm" (click)="startEditTruck()">
              @if (truck()) { Editar } @else { Cadastrar }
            </button>
          </div>

          @if (truck()) {
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5">
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Placa</dt>
                <dd class="mt-1 text-sm text-slate-900 font-mono font-semibold">{{ truck()!.license_plate }}</dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Ano de Fabricação</dt>
                <dd class="mt-1 text-sm text-slate-900">{{ truck()!.manufacture_year || '—' }}</dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Marca</dt>
                <dd class="mt-1 text-sm text-slate-900">{{ truck()!.brand || '—' }}</dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Modelo</dt>
                <dd class="mt-1 text-sm text-slate-900">{{ truck()!.model || '—' }}</dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Capacidade</dt>
                <dd class="mt-1 text-sm text-slate-900">
                  @if (truck()!.capacity_kg) { {{ truck()!.capacity_kg! | number }} kg } @else { — }
                </dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">RENAVAM</dt>
                <dd class="mt-1 text-sm text-slate-900 font-mono">{{ truck()!.renavam || '—' }}</dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Tipo de Caminhão</dt>
                <dd class="mt-1 text-sm text-slate-900">{{ truck()!.truck_type?.name || '—' }}</dd>
              </div>
              <div>
                <dt class="text-xs font-medium text-slate-500 uppercase tracking-wide">Carroceria</dt>
                <dd class="mt-1 text-sm text-slate-900">{{ truck()!.body_type?.name || '—' }}</dd>
              </div>
            </dl>
          } @else {
            <div class="py-10 text-center">
              <svg class="w-12 h-12 text-slate-300 mx-auto mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M3 4a1 1 0 0 1 1-1h12a1 1 0 0 1 .894.553L19.382 7H21a1 1 0 0 1 1 1v6a1 1 0 0 1-1 1h-1.17A3 3 0 0 1 14 17H10a3 3 0 0 1-5.83-2H4a1 1 0 0 1-1-1V4z"/>
              </svg>
              <p class="text-slate-500 font-medium">Nenhum caminhão cadastrado</p>
              <p class="text-sm text-slate-400 mt-1">Clique em "Cadastrar" para adicionar seu caminhão.</p>
            </div>
          }
        </div>

      } @else {
        <!-- Edit: caminhão -->
        <div class="bg-white rounded-2xl border border-slate-200 p-6">
          <h2 class="text-lg font-semibold text-slate-900 mb-6">
            @if (truck()) { Editar Caminhão } @else { Cadastrar Caminhão }
          </h2>

          <div class="space-y-6">
            <!-- Identificação -->
            <div>
              <h3 class="text-sm font-semibold text-slate-700 mb-4">Identificação</h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1.5">Placa *</label>
                  <input hlmInput type="text" [(ngModel)]="editPlate" maxlength="8" placeholder="ABC1D23" class="w-full uppercase" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1.5">RENAVAM</label>
                  <input hlmInput type="text" [(ngModel)]="editRenavam" maxlength="11" class="w-full" />
                </div>
              </div>
            </div>

            <!-- Dados do veículo -->
            <div class="pt-4 border-t border-slate-100">
              <h3 class="text-sm font-semibold text-slate-700 mb-4">Dados do Veículo</h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1.5">Marca</label>
                  <input hlmInput type="text" [(ngModel)]="editBrand" placeholder="ex: Volvo" class="w-full" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1.5">Modelo</label>
                  <input hlmInput type="text" [(ngModel)]="editModel" placeholder="ex: FH 540" class="w-full" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1.5">Ano de Fabricação</label>
                  <input hlmInput type="number" [(ngModel)]="editYear" min="1950" max="2030" placeholder="2020" class="w-full" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1.5">Capacidade (kg)</label>
                  <input hlmInput type="number" [(ngModel)]="editCapacity" min="1" placeholder="25000" class="w-full" />
                </div>
              </div>
            </div>

            <!-- Tipo e Carroceria -->
            <div class="pt-4 border-t border-slate-100">
              <h3 class="text-sm font-semibold text-slate-700 mb-4">Tipo e Carroceria</h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1.5">Tipo de Caminhão</label>
                  <select
                    [(ngModel)]="editTruckTypeId"
                    (ngModelChange)="onTruckTypeChange()"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary bg-white"
                  >
                    <option value="">Selecione</option>
                    @for (type of truckTypes(); track type.id) {
                      <option [value]="type.id">{{ type.name }}</option>
                    }
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium text-slate-700 mb-1.5">Carroceria</label>
                  <select
                    [(ngModel)]="editBodyTypeId"
                    [disabled]="!editTruckTypeId || bodyTypes().length === 0"
                    class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary bg-white disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <option value="">
                      @if (!editTruckTypeId) { Selecione o tipo primeiro } @else if (bodyTypes().length === 0) { Carregando... } @else { Selecione }
                    </option>
                    @for (body of bodyTypes(); track body.id) {
                      <option [value]="body.id">{{ body.name }}</option>
                    }
                  </select>
                </div>
              </div>
            </div>
          </div>

          @if (saveTruckError()) {
            <p class="text-sm text-red-600 mt-4">{{ saveTruckError() }}</p>
          }

          <div class="mt-6 flex justify-end gap-3">
            <button hlmBtn variant="outline" (click)="cancelEditTruck()">Cancelar</button>
            <button hlmBtn (click)="saveTruck()" [disabled]="savingTruck() || !editPlate.trim()">
              @if (savingTruck()) { Salvando... } @else { Salvar caminhão }
            </button>
          </div>
        </div>
      }
    }
  </div>
</section>

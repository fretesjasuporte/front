<!-- Header -->
<div class="pt-20 bg-slate-950">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <span class="text-brand-green text-sm font-semibold tracking-widest uppercase">Suporte</span>
    <h1 class="text-4xl sm:text-5xl font-bold text-white mt-3 leading-tight">Central de Suporte</h1>
    <p class="text-slate-300 text-lg mt-3 leading-relaxed max-w-xl">
      Abra um chamado e acompanhe o status das suas solicitações.
    </p>
  </div>
</div>

<!-- Content -->
<section class="py-10 bg-slate-50 min-h-screen">
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 space-y-6">

    <!-- Toolbar -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <select
          [(ngModel)]="filterStatus"
          (ngModelChange)="applyFilter()"
          class="rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary bg-white"
        >
          <option value="">Todos os chamados</option>
          <option value="open">Abertos</option>
          <option value="in_progress">Em atendimento</option>
          <option value="closed">Encerrados</option>
        </select>
        @if (!loading()) {
          <p class="text-sm text-slate-500">
            <span class="font-semibold text-slate-900">{{ total() }}</span> chamado(s)
          </p>
        }
      </div>
      <button hlmBtn (click)="toggleForm()">
        @if (showForm()) { Cancelar } @else { + Novo chamado }
      </button>
    </div>

    <!-- Success alert -->
    @if (submitSuccess()) {
      <div class="bg-green-50 border border-green-200 rounded-xl px-4 py-3 flex items-center gap-3">
        <svg class="w-5 h-5 text-green-600 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 6 9 17l-5-5"/>
        </svg>
        <p class="text-sm text-green-700 font-medium">Chamado aberto com sucesso! Nossa equipe entrará em contato.</p>
      </div>
    }

    <!-- New Ticket Form -->
    @if (showForm()) {
      <div class="bg-white rounded-2xl border border-slate-200 p-6">
        <h2 class="text-base font-semibold text-slate-900 mb-4">Novo chamado</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1.5">Assunto *</label>
            <input
              hlmInput
              type="text"
              [(ngModel)]="newSubject"
              placeholder="Descreva brevemente o problema"
              maxlength="200"
              class="w-full"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1.5">Mensagem *</label>
            <textarea
              [(ngModel)]="newMessage"
              rows="5"
              maxlength="2000"
              placeholder="Descreva em detalhes o que aconteceu..."
              class="w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/30 focus:border-primary resize-none"
            ></textarea>
            <p class="text-xs text-slate-400 mt-1 text-right">{{ newMessage.length }}/2000</p>
          </div>
        </div>
        @if (submitError()) {
          <p class="text-sm text-red-600 mt-3">{{ submitError() }}</p>
        }
        <div class="mt-4 flex justify-end gap-3">
          <button hlmBtn variant="outline" (click)="toggleForm()">Cancelar</button>
          <button
            hlmBtn
            (click)="openTicket()"
            [disabled]="submitting() || !newSubject.trim() || !newMessage.trim()"
          >
            @if (submitting()) { Enviando... } @else { Enviar chamado }
          </button>
        </div>
      </div>
    }

    <!-- Tickets List -->
    @if (loading()) {
      <div class="space-y-3">
        @for (i of [1,2,3]; track i) {
          <div class="bg-white rounded-2xl border border-slate-200 p-5 animate-pulse">
            <div class="flex justify-between items-start">
              <div class="space-y-2 flex-1">
                <div class="h-4 bg-slate-200 rounded w-64"></div>
                <div class="h-3 bg-slate-100 rounded w-40"></div>
              </div>
              <div class="h-6 bg-slate-200 rounded w-20"></div>
            </div>
          </div>
        }
      </div>
    } @else if (error()) {
      <div class="bg-red-50 border border-red-200 rounded-2xl p-6 text-center">
        <p class="text-red-700">{{ error() }}</p>
        <button hlmBtn variant="outline" class="mt-3" (click)="load(true)">Tentar novamente</button>
      </div>
    } @else if (!tickets().length) {
      <div class="bg-white rounded-2xl border border-slate-200 p-16 text-center">
        <svg class="w-12 h-12 text-slate-300 mx-auto mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        <p class="text-slate-500 font-medium">Nenhum chamado encontrado</p>
        <p class="text-sm text-slate-400 mt-1">Clique em "Novo chamado" para entrar em contato com o suporte.</p>
      </div>
    } @else {
      <div class="space-y-3">
        @for (ticket of tickets(); track ticket.id) {
          <div class="bg-white rounded-2xl border border-slate-200 p-5">
            <div class="flex items-start justify-between gap-3 flex-wrap mb-3">
              <div class="flex-1 min-w-0">
                <p class="font-semibold text-slate-900 mb-0.5">{{ ticket.subject }}</p>
                <p class="text-xs text-slate-400">
                  Aberto em {{ ticket.created_at | date:'dd/MM/yyyy HH:mm' }}
                </p>
              </div>
              <span hlmBadge [variant]="statusClass(ticket.status)">
                {{ statusLabel(ticket.status) }}
              </span>
            </div>

            <p class="text-sm text-slate-600 leading-relaxed border-t border-slate-100 pt-3">
              {{ ticket.message }}
            </p>

            @if (ticket.reply) {
              <div class="mt-3 bg-blue-50 border border-blue-200 rounded-xl px-4 py-3">
                <p class="text-xs font-semibold text-blue-600 mb-1">Resposta do suporte</p>
                <p class="text-sm text-blue-800 leading-relaxed">{{ ticket.reply }}</p>
                @if (ticket.replied_at) {
                  <p class="text-xs text-blue-500 mt-1.5">
                    {{ ticket.replied_at | date:'dd/MM/yyyy HH:mm' }}
                  </p>
                }
              </div>
            }
          </div>
        }
      </div>

      @if (hasMore()) {
        <div class="text-center">
          <button hlmBtn variant="outline" (click)="loadMore()" [disabled]="loadingMore()">
            @if (loadingMore()) { Carregando... } @else { Carregar mais }
          </button>
        </div>
      }
    }
  </div>
</section>
